@model onlineExamApp.ViewModel.ExamDetailsViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer


@{
    ViewData["Title"] = Localizer["ExamDetails"];
}
<head>
    <link rel="stylesheet" href="~/css/page.css" asp-append-version="true" />
</head>

<div class="container mt-4">
    <h2 class="mb-3">@Model.Exam.Title</h2>

    <div class="mb-3">
        <p><strong>@Localizer["Subject"]:</strong> @Model.Exam.Subject</p>
        <p><strong>@Localizer["Difficulty"]:</strong> @Model.Exam.Difficulty</p>
        <p><strong>@Localizer["Duration"]:</strong> @Model.Exam.DurationMinutes @Localizer["Minutes"]</p>
        <p><strong>@Localizer["StartTime"]:</strong> @Model.Exam.StartTimeUtc.ToString("f")</p>
        <p><strong>@Localizer["EndTime"]:</strong> @Model.Exam.EndTimeUtc.ToString("f")</p>
        <p><strong>@Localizer["Description"]:</strong> @Model.Exam.Description</p>
        <p><strong>@Localizer["CreatedBy"]:</strong> @Model.Exam.Creator?.UserName</p>
    </div>

    <a asp-action="Edit" asp-route-id="@Model.Exam.Id" class="btn btn-warning me-2">
        <i class="bi bi-pencil-square"></i> @Localizer["EditExam"]
    </a>

    <hr />
    <h4>@Localizer["Questions"]</h4>

    @if (Model.Exam.Questions != null && Model.Exam.Questions.Any())
    {
        <ol>
            @foreach (var question in Model.Exam.Questions)
            {
                <li class="mb-3">
                    <p><strong>@question.Text</strong></p>

                    @if (question.Options != null && question.Options.Any())
                    {
                        <ul>
                            @foreach (var option in question.Options)
                            {
                                <li>
                                    @option.Text
                                    @if (option.IsCorrect)
                                    {
                                        <span class="badge bg-success ms-1">@Localizer["Correct"]</span>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">@Localizer["NoOptions"]</p>
                    }
                </li>
            }
        </ol>
    }
    else
    {
        <p class="text-muted">@Localizer["NoQuestions"]</p>
    }

    <hr />
    <h4>@Localizer["StudentsWhoTookExam"]</h4>

    @if (!Model.StudentAttempts.Any())
    {
        <p class="text-muted">@Localizer["NoStudents"]</p>
    }
    else
    {
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>@Localizer["Student"]</th>
                    <th>@Localizer["Score"]</th>
                    <th>@Localizer["SubmittedOn"]</th>
                    <th>@Localizer["Attempts"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var group in Model.StudentAttempts.GroupBy(a => a.StudentId))
                {
                    var student = group.First().Student;
                    var submittedAttempt = group
                    .Where(a => a.SubmittedTimeUtc != null)
                    .OrderByDescending(a => a.SubmittedTimeUtc)
                    .FirstOrDefault();

                    <tr>
                        <td>@(student?.DisplayName ?? student?.UserName ?? "Unknown")</td>
                        <td>@(submittedAttempt?.Score ?? 0)</td>
                        <td>@(submittedAttempt?.SubmittedTimeUtc?.ToLocalTime().ToString("g") ?? Localizer["NotSubmitted"].Value)</td>
                        <td>@group.Count()</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <a href="/Exams/MyExams" class="btn btn-outline-secondary mt-4">@Localizer["BackToExams"]</a>
</div>




